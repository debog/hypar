name: CMake CUDA Compilation Test

on: [push, pull_request]

jobs:
  build:
    name: CUDA ${{ matrix.cuda_version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        cuda_version: ["11.2", "11.8"]
        include:
          - cuda_version: "11.2"
            cuda_packages: "cuda-command-line-tools-11-2 cuda-compiler-11-2 cuda-cupti-dev-11-2 cuda-minimal-build-11-2 cuda-nvml-dev-11-2 cuda-nvtx-11-2 libcurand-dev-11-2"
            cuda_link: "cuda-11.2"
          - cuda_version: "11.8"
            cuda_packages: "cuda-command-line-tools-11-8 cuda-compiler-11-8 cuda-cupti-dev-11-8 cuda-minimal-build-11-8 cuda-nvml-dev-11-8 cuda-nvtx-11-8 libcurand-dev-11-8"
            cuda_link: "cuda-11.8"

    steps:
    - uses: actions/checkout@v3

    - name: Install base dependencies
      run: |
        sudo apt-get -qqq update
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          ca-certificates \
          cmake \
          gcc-10 g++-10 \
          mpich libmpich-dev \
          gnupg \
          pkg-config \
          wget

    - name: Set GCC 10 as default
      run: |
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-10 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-10 100
        gcc --version
        g++ --version

    - name: Install CUDA Toolkit ${{ matrix.cuda_version }}
      run: |
        wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb
        sudo dpkg -i cuda-keyring_1.0-1_all.deb
        sudo apt-get update
        sudo apt-get install -y ${{ matrix.cuda_packages }}
        sudo ln -sf ${{ matrix.cuda_link }} /usr/local/cuda

    - name: Verify CUDA installation
      run: |
        /usr/local/cuda/bin/nvcc --version
        ls -la /usr/local/cuda/bin/nvcc
        echo "CUDA installed at /usr/local/cuda"

    - name: Configure CMake
      run: |
        export PATH=/usr/local/cuda/bin:/usr/bin:/bin:$PATH
        /bin/mkdir build
        cd build
        cmake \
          -DENABLE_CUDA=ON \
          -DCUDAToolkit_ROOT=/usr/local/cuda \
          -DCMAKE_CUDA_COMPILER=/usr/local/cuda/bin/nvcc \
          -DCMAKE_CUDA_ARCHITECTURES=70 \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_VERBOSE_MAKEFILE=ON \
          ..
      env:
        CUDACXX: /usr/local/cuda/bin/nvcc

    - name: Build
      run: |
        export PATH=/usr/local/cuda/bin:/usr/bin:/bin:$PATH
        cmake --build build --verbose -j$(nproc)

    - name: Verify executable and libraries
      run: |
        export PATH=/usr/bin:/bin:$PATH
        test -f build/src/HyPar
        file build/src/HyPar
        ldd build/src/HyPar | grep cuda || echo "CUDA runtime linked"
        echo "âœ“ HyPar with CUDA ${{ matrix.cuda_version }} compiled successfully"

    - name: Check CUDA object files
      run: |
        export PATH=/usr/bin:/bin:$PATH
        find build -name "*.o" -type f | head -10
        echo "Build completed with CUDA support"
        echo "Note: Executable cannot run on CI (no GPU hardware available)"
